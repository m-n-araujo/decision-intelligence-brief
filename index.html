<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Decision Intelligence Brief — Simple “Connections” (Lineage) UX</title>
  <style>
    :root{
      --sans:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Segoe UI",Roboto,Helvetica,Arial,system-ui,"Apple Color Emoji","Segoe UI Emoji";
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;

      /* Blue background system */
      --bg:#f3f7ff;
      --bg2:#eef4ff;
      --lane:#e3ecff;
      --lane2:#d6e4ff;
      --halo:rgba(0,113,227,.12);

      /* Reading surfaces */
      --card:#ffffff;

      /* Text */
      --text:#0b1220;
      --muted:#5f6b7a;
      --muted2:#7b8794;

      /* Borders & shadows */
      --border:rgba(11,18,32,.10);
      --border2:rgba(11,18,32,.08);
      --shadow:0 18px 55px rgba(10,40,120,.12);
      --shadow2:0 10px 30px rgba(10,40,120,.10);

      /* Accent */
      --accent:#0071e3;
      --accent2:#5ac8fa;
      --good:#34c759;
      --warn:#ff9f0a;
      --hot:#ff3b30;

      --radius-xl:22px;
      --radius-lg:16px;
      --pill:999px;

      --max:1220px;
    }

    [data-theme="dark"]{
      --bg:#07101f;
      --bg2:#0a1530;
      --lane:#0f2144;
      --lane2:#132a54;
      --halo:rgba(90,200,250,.16);

      --card:#0f1420;

      --text:#f5f7ff;
      --muted:#b6c2d1;
      --muted2:#93a4b8;

      --border:rgba(255,255,255,.14);
      --border2:rgba(255,255,255,.12);

      --shadow:0 18px 60px rgba(0,0,0,.45);
      --shadow2:0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 25% 0%, rgba(0,113,227,.12), transparent 60%),
        radial-gradient(700px 400px at 80% 10%, rgba(90,200,250,.14), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}
    button,input,select{font-family:inherit}

    .page{
      display:grid;
      grid-template-columns:240px minmax(0,var(--max)) 240px;
      gap:18px;
      width:min(1600px, calc(100% - 28px));
      margin:18px auto 44px;
      align-items:start;
    }
    @media (max-width:1180px){
      .page{grid-template-columns:1fr; width:min(var(--max), calc(100% - 28px))}
      .gutter{display:none}
    }
    .gutter{
      position:sticky; top:16px;
      border-radius:var(--radius-xl);
      border:1px dashed rgba(0,113,227,.28);
      background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.45));
      padding:14px;
      min-height:520px;
      box-shadow:var(--shadow2);
      color:var(--muted);
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .gutter{
      background:linear-gradient(180deg, rgba(16,26,42,.75), rgba(16,26,42,.55));
      border-color:rgba(90,200,250,.22);
    }
    .gutter h3{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:var(--muted2);
    }
    .gutter p{margin:0; font-size:12px; line-height:1.5}
    .main{min-width:0}

    /* Top bar */
    .topbar{
      border-radius:var(--radius-xl);
      background:linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.62));
      border:1px solid rgba(0,113,227,.18);
      box-shadow:var(--shadow2);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .topbar{
      background:linear-gradient(180deg, rgba(16,26,42,.78), rgba(16,26,42,.62));
      border-color:rgba(90,200,250,.18);
    }
    .topbarInner{
      padding:16px;
      display:flex; gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:flex-start; min-width:320px; max-width:820px}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.65), transparent 60%),
        linear-gradient(135deg, rgba(0,113,227,.95), rgba(90,200,250,.80));
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 12px 30px rgba(0,113,227,.22);
      flex:0 0 auto;
    }
    [data-theme="dark"] .logo{border-color:rgba(255,255,255,.10)}
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px; line-height:1.15}
    .brand p{margin:5px 0 0; font-size:12px; color:var(--muted); line-height:1.45}

    .kpis{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:stretch}
    .kpi{
      min-width:170px;
      padding:12px 14px;
      border-radius:var(--radius-lg);
      background:rgba(255,255,255,.85);
      border:1px solid rgba(0,113,227,.14);
      box-shadow:0 8px 20px rgba(10,40,120,.10);
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .kpi{
      background:rgba(16,26,42,.75);
      border-color:rgba(90,200,250,.16);
      box-shadow:var(--shadow2);
    }
    .kpi .k{font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:.35px}
    .kpi .v{margin-top:6px; display:flex; gap:8px; align-items:baseline}
    .kpi strong{font-size:18px; letter-spacing:.2px}
    .kpi span{font-size:12px; color:var(--muted)}

    .controls{
      padding:12px 16px 16px;
      border-top:1px solid rgba(0,113,227,.12);
      display:grid;
      grid-template-columns:1.7fr 1fr 1fr;
      gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.15));
    }
    [data-theme="dark"] .controls{
      background:linear-gradient(180deg, rgba(16,26,42,.35), rgba(16,26,42,.15));
      border-top-color:rgba(90,200,250,.12);
    }
    @media (max-width:900px){ .controls{grid-template-columns:1fr} }

    .control{
      border-radius:var(--radius-lg);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,113,227,.14);
      box-shadow:0 8px 20px rgba(10,40,120,.10);
      padding:10px;
      display:flex; gap:10px;
      align-items:center;
      min-height:52px;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .control{
      background:rgba(16,26,42,.78);
      border-color:rgba(90,200,250,.14);
      box-shadow:var(--shadow2);
    }
    .control:focus-within{border-color:rgba(0,113,227,.40); box-shadow:0 0 0 6px var(--halo)}
    .icon{
      width:34px;height:34px;border-radius:12px;
      display:grid; place-items:center;
      font-family:var(--mono);
      font-size:12px;
      background:rgba(0,113,227,.10);
      border:1px solid rgba(0,113,227,.22);
      flex:0 0 auto;
      color:var(--text);
    }
    .icon.green{background:rgba(52,199,89,.10); border-color:rgba(52,199,89,.22)}
    .icon.amber{background:rgba(255,159,10,.10); border-color:rgba(255,159,10,.22)}
    input[type="text"], select{
      width:100%;
      background:transparent;
      border:none; outline:none;
      color:var(--text);
      font-size:13px;
    }
    input::placeholder{color:rgba(95,107,122,.85)}
    [data-theme="dark"] input::placeholder{color:rgba(182,194,209,.75)}
    select{appearance:none; cursor:pointer}

    .subbar{
      margin-top:12px;
      display:flex; justify-content:space-between;
      gap:12px; align-items:center;
      flex-wrap:wrap;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      padding:8px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.16);
      background:rgba(227,236,255,.60);
      color:var(--muted);
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition:transform .08s ease, border-color .15s ease, background .15s ease, color .15s ease;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .chip{background:rgba(15,33,68,.65); border-color:rgba(90,200,250,.16)}
    .chip:hover{transform:translateY(-1px); border-color:rgba(0,113,227,.28)}
    .chip.active{color:var(--text); border-color:rgba(0,113,227,.42); background:rgba(0,113,227,.10)}

    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .btn{
      border:1px solid rgba(0,113,227,.16);
      background:rgba(227,236,255,.55);
      color:var(--text);
      padding:10px 12px;
      border-radius:var(--radius-lg);
      cursor:pointer;
      font-size:12px;
      transition:transform .08s ease, border-color .15s ease, background .15s ease;
      box-shadow:0 8px 20px rgba(10,40,120,.10);
      display:flex; gap:10px; align-items:center;
      user-select:none;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .btn{background:rgba(15,33,68,.65); border-color:rgba(90,200,250,.16); box-shadow:var(--shadow2)}
    .btn:hover{transform:translateY(-1px); border-color:rgba(0,113,227,.30); background:rgba(214,228,255,.65)}
    [data-theme="dark"] .btn:hover{background:rgba(19,42,84,.75)}
    .btn.primary{background:rgba(0,113,227,.14); border-color:rgba(0,113,227,.32)}
    .dot{width:8px;height:8px;border-radius:99px; background:var(--accent); box-shadow:0 0 0 4px rgba(0,113,227,.14)}

    /* ===== NEW: SUPER SIMPLE “CONNECTIONS” MODE ===== */
    .connBar{
      margin-top:10px;
      border-radius:var(--radius-xl);
      border:1px solid rgba(0,113,227,.16);
      background:linear-gradient(180deg, rgba(214,228,255,.60), rgba(227,236,255,.35));
      box-shadow:var(--shadow2);
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .connBar{
      background:linear-gradient(180deg, rgba(19,42,84,.70), rgba(15,33,68,.45));
      border-color:rgba(90,200,250,.14);
      box-shadow:var(--shadow2);
    }
    .connLeft{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .connTitle{
      font-weight:800;
      font-size:12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:var(--muted2);
      display:flex;
      gap:8px;
      align-items:center;
    }
    .toggle{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.16);
      background:rgba(255,255,255,.70);
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    [data-theme="dark"] .toggle{background:rgba(16,26,42,.70); border-color:rgba(90,200,250,.14)}
    .switch{
      width:44px; height:26px;
      border-radius:99px;
      border:1px solid rgba(0,113,227,.18);
      background:rgba(0,0,0,.06);
      position:relative;
      flex:0 0 auto;
    }
    [data-theme="dark"] .switch{background:rgba(255,255,255,.10); border-color:rgba(90,200,250,.18)}
    .knob{
      width:22px;height:22px;border-radius:99px;
      background:rgba(255,255,255,.95);
      position:absolute; top:1px; left:1px;
      transition:left .18s ease, background .18s ease;
      box-shadow:0 10px 22px rgba(0,0,0,.10);
    }
    [data-theme="dark"] .knob{background:rgba(245,247,255,.92); box-shadow:0 10px 22px rgba(0,0,0,.35)}
    .toggle.active .switch{background:rgba(0,113,227,.20)}
    .toggle.active .knob{left:21px; background:rgba(255,255,255,.98)}
    .helpPill{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.12);
      background:rgba(255,255,255,.55);
    }
    [data-theme="dark"] .helpPill{background:rgba(16,26,42,.55); border-color:rgba(90,200,250,.12)}
    .connRight{margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .miniCount{
      font-family:var(--mono);
      font-size:12px;
      padding:8px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.14);
      background:rgba(255,255,255,.65);
      color:var(--text);
    }
    [data-theme="dark"] .miniCount{background:rgba(16,26,42,.65); border-color:rgba(90,200,250,.14)}
    .btnDanger{
      border-color: rgba(255,59,48,.22);
      background: rgba(255,59,48,.10);
    }

    /* Clusters */
    .clusters{margin-top:12px; display:flex; flex-direction:column; gap:12px}
    .cluster{
      border-radius:var(--radius-xl);
      background:rgba(255,255,255,.60);
      border:1px solid rgba(0,113,227,.16);
      box-shadow:var(--shadow2);
      overflow:hidden;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .cluster{background:rgba(16,26,42,.60); border-color:rgba(90,200,250,.14)}
    .clusterHeader{
      padding:14px 16px 12px;
      border-bottom:1px solid rgba(0,113,227,.12);
      display:flex; justify-content:space-between;
      gap:10px; align-items:center;
      flex-wrap:wrap;
      background:linear-gradient(180deg, rgba(214,228,255,.65), rgba(227,236,255,.35));
    }
    [data-theme="dark"] .clusterHeader{
      background:linear-gradient(180deg, rgba(19,42,84,.70), rgba(15,33,68,.45));
      border-bottom-color:rgba(90,200,250,.12);
    }
    .clusterHeader h2{margin:0; font-size:14px; letter-spacing:.2px}
    .clusterMeta{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .pill{
      font-size:11px;
      padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.14);
      background:rgba(255,255,255,.78);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
      backdrop-filter:blur(10px);
    }
    [data-theme="dark"] .pill{background:rgba(16,26,42,.72); border-color:rgba(90,200,250,.14)}
    .pill .b{width:6px;height:6px;border-radius:99px; background:var(--good); box-shadow:0 0 0 4px rgba(52,199,89,.14)}
    .pill.hot .b{background:var(--hot); box-shadow:0 0 0 4px rgba(255,59,48,.14)}
    .pill.warn .b{background:var(--warn); box-shadow:0 0 0 4px rgba(255,159,10,.14)}

    /* Rows area with blue lanes */
    .rows{
      padding:10px 10px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      background:linear-gradient(180deg, var(--lane), var(--lane2));
    }

    .row{
      border-radius:16px;
      border:1px solid var(--border2);
      background:var(--card);
      box-shadow:0 10px 26px rgba(10,40,120,.10);
      padding:10px;
      display:grid;
      grid-template-columns:120px 1.2fr 1fr 1.6fr 220px 170px;
      gap:10px;
      align-items:center;
      cursor:pointer;
      transition:transform .08s ease, border-color .15s ease, box-shadow .15s ease;
      overflow:hidden;
      position:relative;
    }
    [data-theme="dark"] .row{
      background:var(--card);
      border-color:rgba(255,255,255,.12);
      box-shadow:var(--shadow2);
    }
    .row:hover{transform:translateY(-1px); border-color:rgba(0,113,227,.26); box-shadow:0 14px 34px rgba(10,40,120,.14)}

    /* left freshness ribbon */
    .row::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0;
      width:5px;
      background:rgba(0,113,227,.14);
    }
    .row.fresh-7::before{background:rgba(255,59,48,.45)}
    .row.fresh-30::before{background:rgba(52,199,89,.45)}
    .row.fresh-365::before{background:rgba(255,159,10,.45)}

    /* ===== NEW: connection-mode visuals ===== */
    .row.connectMode{
      border-color: rgba(0,113,227,.38);
      box-shadow: 0 16px 40px rgba(0,113,227,.14);
    }
    .row.selectedFrom{
      border-color: rgba(255,159,10,.42);
      box-shadow: 0 16px 42px rgba(255,159,10,.16);
    }
    .row.selectedTo{
      border-color: rgba(0,113,227,.55);
      box-shadow: 0 18px 46px rgba(0,113,227,.18);
    }
    .badge{
      display:none;
      position:absolute;
      right:10px; top:10px;
      padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.16);
      background: rgba(0,113,227,.10);
      font-size:11px;
      color: var(--text);
      backdrop-filter: blur(10px);
      user-select:none;
    }
    .row.selectedFrom .badge{display:inline-flex; border-color:rgba(255,159,10,.22); background:rgba(255,159,10,.12)}
    .row.selectedTo .badge{display:inline-flex}
    .row.selectedFrom .badge::before{content:"From · "; font-weight:800}
    .row.selectedTo .badge::before{content:"To · "; font-weight:800}

    .row .cell{min-width:0; padding-left:8px; border-left:1px solid rgba(11,18,32,.06)}
    .row .cell:first-child{border-left:none; padding-left:0}
    [data-theme="dark"] .row .cell{border-left-color:rgba(255,255,255,.08)}

    @media (max-width:1180px){
      .row{grid-template-columns:120px 1.2fr 1fr 1.4fr 200px 170px}
    }
    @media (max-width:980px){
      .row{grid-template-columns:110px 1fr 1fr 1.2fr 160px 170px}
      .srcHost{max-width:150px}
    }
    @media (max-width:780px){
      .row{grid-template-columns:110px 1fr; grid-auto-rows:auto}
      .cell{grid-column:span 2; border-left:none!important; padding-left:0!important}
      .cell.date{grid-column:span 1}
      .cell.actions{grid-column:span 1; justify-content:flex-end}
      .badge{right:10px; top:54px}
    }

    .cell.date{
      font-family:var(--mono);
      font-size:11px;
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
      padding-left:0;
    }
    .cell.date .d{
      width:8px;height:8px;border-radius:99px;
      background:var(--good);
      box-shadow:0 0 0 4px rgba(52,199,89,.12);
    }
    .cell.date .d.hot{background:var(--hot); box-shadow:0 0 0 4px rgba(255,59,48,.12)}

    .topic{font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .subtopic{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .summary{
      font-size:12px; opacity:.92; line-height:1.35;
      display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden;
    }

    .src{display:flex; flex-direction:column; gap:4px; min-width:0}
    .src .lbl{font-size:10px; color:var(--muted2); text-transform:uppercase; letter-spacing:.35px}
    .srcHost{font-family:var(--mono); font-size:12px; opacity:.92; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:200px}

    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.14);
      background:rgba(227,236,255,.55);
      font-size:11px; color:var(--muted);
      white-space:nowrap;
      margin-top:6px;
    }
    [data-theme="dark"] .tag{background:rgba(15,33,68,.60); border-color:rgba(90,200,250,.14)}
    .tag .b{width:6px;height:6px;border-radius:99px; background:var(--accent); box-shadow:0 0 0 4px rgba(0,113,227,.10)}
    .tag.hot .b{background:var(--hot); box-shadow:0 0 0 4px rgba(255,59,48,.10)}
    .tag.green .b{background:var(--good); box-shadow:0 0 0 4px rgba(52,199,89,.10)}
    .tag.amber .b{background:var(--warn); box-shadow:0 0 0 4px rgba(255,159,10,.10)}

    .cell.actions{
      display:flex; gap:8px; justify-content:flex-end; align-items:center;
      border-left:none; padding-left:0;
    }
    .iconBtn{
      height:38px;
      padding:0 12px;
      border-radius:14px;
      border:1px solid rgba(0,113,227,.14);
      background:rgba(227,236,255,.45);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      transition:transform .08s ease, border-color .15s ease, background .15s ease;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
      color:var(--text);
    }
    [data-theme="dark"] .iconBtn{background:rgba(15,33,68,.60); border-color:rgba(90,200,250,.14)}
    .iconBtn:hover{transform:translateY(-1px); border-color:rgba(0,113,227,.28); background:rgba(214,228,255,.60)}
    [data-theme="dark"] .iconBtn:hover{background:rgba(19,42,84,.75)}
    .iconBtn.star.active{border-color:rgba(255,159,10,.40); background:rgba(255,159,10,.14)}

    /* NEW: Make Connect button extremely obvious in connect mode */
    .iconBtn.connect{
      border-color: rgba(0,113,227,.28);
      background: rgba(0,113,227,.10);
      font-weight:800;
    }
    .connectMode .iconBtn.connect{
      border-color: rgba(255,159,10,.35);
      background: rgba(255,159,10,.14);
    }

    .empty{
      margin-top:14px;
      border-radius:var(--radius-xl);
      border:1px dashed rgba(0,113,227,.22);
      background:rgba(227,236,255,.55);
      padding:18px;
      color:var(--muted);
      box-shadow:var(--shadow2);
      backdrop-filter:blur(10px);
    }

    /* Details modal */
    .modalOverlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modalOverlay.show{display:flex}
    .modal{
      width:min(920px, 100%);
      border-radius:22px;
      border:1px solid rgba(0,113,227,.18);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter:blur(12px);
    }
    [data-theme="dark"] .modal{background:rgba(16,26,42,.92); border-color:rgba(90,200,250,.16)}
    .modalHeader{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(0,113,227,.12);
      display:flex; justify-content:space-between; gap:12px; align-items:flex-start;
      background:linear-gradient(180deg, rgba(214,228,255,.55), rgba(255,255,255,.10));
    }
    [data-theme="dark"] .modalHeader{background:linear-gradient(180deg, rgba(19,42,84,.70), rgba(16,26,42,.20)); border-bottom-color:rgba(90,200,250,.12)}
    .modalHeader h2{margin:0; font-size:18px; line-height:1.2}
    .modalHeader p{margin:6px 0 0; font-size:12px; color:var(--muted); line-height:1.4}
    .closeBtn{
      width:44px;height:44px;border-radius:16px;
      border:1px solid rgba(0,113,227,.14);
      background:rgba(227,236,255,.45);
      cursor:pointer;
      display:grid; place-items:center;
      color:var(--text);
      flex:0 0 auto;
    }
    [data-theme="dark"] .closeBtn{background:rgba(15,33,68,.60); border-color:rgba(90,200,250,.14)}
    .modalBody{
      padding:14px 16px 16px;
      display:grid;
      grid-template-columns:1.35fr .65fr;
      gap:14px;
    }
    @media (max-width:860px){ .modalBody{grid-template-columns:1fr} }
    .panel{
      border-radius:18px;
      border:1px solid rgba(0,113,227,.12);
      background:rgba(255,255,255,.86);
      padding:14px;
    }
    [data-theme="dark"] .panel{background:rgba(15,33,68,.45); border-color:rgba(90,200,250,.12)}
    .panel h3{
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.35px;
      text-transform:uppercase;
      color:var(--muted2);
    }
    .panel .text{margin:0; font-size:14px; line-height:1.55; opacity:.96}
    .kv{
      display:grid;
      grid-template-columns:110px 1fr;
      gap:8px 10px;
      align-items:start;
      font-size:12px;
      line-height:1.35;
    }
    .kv .k{color:var(--muted)}
    .kv .v{color:var(--text)}
    .kv a{color:var(--accent); text-decoration:underline; text-underline-offset:3px; word-break:break-word}

    /* ===== NEW: “Connections” panel (replaces confusing graph) ===== */
    .connOverlayPanel{
      position:fixed;
      right: 18px;
      bottom: 18px;
      width: min(420px, calc(100% - 36px));
      max-height: 60vh;
      display:none;
      z-index:40;
    }
    .connOverlayPanel.show{display:block}
    .connCard{
      border-radius:22px;
      border:1px solid rgba(0,113,227,.18);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    [data-theme="dark"] .connCard{background: rgba(16,26,42,.92); border-color: rgba(90,200,250,.16)}
    .connCardHeader{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(0,113,227,.12);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(214,228,255,.55), rgba(255,255,255,.10));
    }
    [data-theme="dark"] .connCardHeader{background: linear-gradient(180deg, rgba(19,42,84,.70), rgba(16,26,42,.20)); border-bottom-color: rgba(90,200,250,.12)}
    .connCardHeader .t{
      font-weight: 900;
      font-size: 12px;
      letter-spacing: .35px;
      text-transform: uppercase;
      color: var(--muted2);
    }
    .connCardBody{
      padding: 12px 14px;
      background: linear-gradient(180deg, var(--lane), var(--lane2));
      max-height: 52vh;
      overflow:auto;
    }
    .edgeItem{
      border-radius: 16px;
      border: 1px solid rgba(0,113,227,.14);
      background: rgba(255,255,255,.90);
      padding: 10px 10px;
      margin-bottom: 10px;
    }
    [data-theme="dark"] .edgeItem{
      background: rgba(16,26,42,.85);
      border-color: rgba(90,200,250,.12);
    }
    .edgeTop{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .edgeTop .label{
      font-size: 12px;
      font-weight: 800;
      line-height: 1.25;
    }
    .edgeTop .mini{
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .edgeBtns{display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px}
    .tinyBtn{
      border:1px solid rgba(0,113,227,.14);
      background: rgba(227,236,255,.55);
      border-radius: 14px;
      padding: 8px 10px;
      font-size: 12px;
      cursor:pointer;
    }
    [data-theme="dark"] .tinyBtn{background: rgba(15,33,68,.60); border-color: rgba(90,200,250,.14)}
    .tinyBtn.danger{
      border-color: rgba(255,59,48,.24);
      background: rgba(255,59,48,.10);
    }

    .toast{
      position:fixed;
      bottom:18px;
      left:50%;
      transform:translateX(-50%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(0,113,227,.16);
      box-shadow:0 16px 50px rgba(10,40,120,.16);
      border-radius:var(--pill);
      padding:10px 14px;
      font-size:12px;
      display:none;
      z-index:60;
      backdrop-filter:blur(12px);
    }
    [data-theme="dark"] .toast{background:rgba(16,26,42,.92); border-color:rgba(90,200,250,.14); box-shadow:var(--shadow2)}
    .toast.show{display:block; animation:pop .18s ease}
    @keyframes pop{
      from{transform:translateX(-50%) translateY(6px); opacity:0}
      to{transform:translateX(-50%) translateY(0); opacity:1}
    }

    .footer{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .footer code{
      font-family:var(--mono);
      font-size:11px;
      padding:3px 8px;
      border-radius:var(--pill);
      border:1px solid rgba(0,113,227,.14);
      background:rgba(227,236,255,.55);
      color:var(--text);
    }

    .row:focus-visible,.chip:focus-visible,.btn:focus-visible,.iconBtn:focus-visible,.closeBtn:focus-visible,.toggle:focus-visible,.tinyBtn:focus-visible{
      outline:none;
      box-shadow:0 0 0 6px var(--halo);
      border-color:rgba(0,113,227,.40)!important;
    }
  </style>
</head>

<body>
  <div class="page">
    <aside class="gutter" aria-label="Left sidebar for future advertising">
      <h3>Left space</h3>
      <p>Reserved: ads, sponsorships, newsletter signup, featured tools.</p>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="topbarInner">
          <div class="brand">
            <div class="logo" aria-hidden="true"></div>
            <div>
              <h1>Decision Intelligence Brief</h1>
              <p><strong>Connections</strong> are now simple: turn it on → click an article → click another article → done.</p>
            </div>
          </div>

          <div class="kpis">
            <div class="kpi">
              <div class="k">Items in feed</div>
              <div class="v"><strong id="statTotal">0</strong><span>entries</span></div>
            </div>
            <div class="kpi">
              <div class="k">Visible now</div>
              <div class="v"><strong id="statVisible">0</strong><span>entries</span></div>
            </div>
          </div>
        </div>

        <div class="controls">
          <div class="control" title="Search topic, subtopic, summary, source">
            <div class="icon">⌕</div>
            <input id="q" type="text" placeholder="Search: agentic, bias, DAO, governance, leadership…" autocomplete="off" />
          </div>
          <div class="control" title="Area of interest (topic filter)">
            <div class="icon green">◎</div>
            <select id="interestSelect"></select>
          </div>
          <div class="control" title="Sort within clusters or globally">
            <div class="icon amber">⇅</div>
            <select id="sortSelect">
              <option value="cluster_then_date_desc">Topic clusters → newest first</option>
              <option value="cluster_then_date_asc">Topic clusters → oldest first</option>
              <option value="date_desc">Global newest first</option>
              <option value="date_asc">Global oldest first</option>
            </select>
          </div>
        </div>
      </header>

      <div class="subbar">
        <div class="chips" id="timeChips" aria-label="Time window filters"></div>
        <div class="actions">
          <button class="btn" id="themeBtn" type="button">Theme</button>
          <button class="btn" id="resetBtn" type="button">Reset</button>
          <button class="btn" id="copyBtn" type="button">Copy sources</button>
        </div>
      </div>

      <!-- NEW: Connections bar -->
      <div class="connBar" aria-label="Connections controls">
        <div class="connLeft">
          <div class="connTitle">Connections</div>

          <div id="connectToggle" class="toggle" role="button" tabindex="0" aria-pressed="false" title="Turn on Connections mode">
            <div class="switch"><div class="knob"></div></div>
            <div><strong id="toggleText">Off</strong></div>
          </div>

          <div class="helpPill" id="helpText">
            Turn on → click <b>From</b> article → click <b>To</b> article.
          </div>
        </div>

        <div class="connRight">
          <span class="miniCount" id="edgeCount">0 connections</span>
          <button class="btn" id="viewConnectionsBtn" type="button">View connections</button>
          <button class="btn btnDanger" id="clearConnectionsBtn" type="button">Clear</button>
        </div>
      </div>

      <section class="clusters" id="clusters" aria-live="polite"></section>
      <div id="empty" class="empty" style="display:none;">No results match your filters.</div>

      <div class="footer">
        <div>UX tip: in Connections mode, clicking a row won’t open details — it will help you connect two items.</div>
        <div><code>single-file MVP</code></div>
      </div>
    </main>

    <aside class="gutter" aria-label="Right sidebar for future advertising">
      <h3>Right space</h3>
      <p>Reserved: affiliates, promoted studies, “Featured framework”.</p>
    </aside>
  </div>

  <!-- Details Modal -->
  <div id="modalOverlay" class="modalOverlay" role="dialog" aria-modal="true" aria-label="Details dialog">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <h2 id="mTitle">Title</h2>
          <p id="mSub">Sub</p>
        </div>
        <button class="closeBtn" id="closeModal" type="button" aria-label="Close">✕</button>
      </div>

      <div class="modalBody">
        <div class="panel">
          <h3>Full details</h3>
          <p class="text" id="mDetails"></p>
        </div>

        <div class="panel">
          <h3>Metadata</h3>
          <div class="kv">
            <div class="k">Date</div><div class="v" id="mDate"></div>
            <div class="k">Topic</div><div class="v" id="mTopic"></div>
            <div class="k">Subtopic</div><div class="v" id="mSubtopic"></div>
            <div class="k">How new</div><div class="v" id="mNewness"></div>
            <div class="k">Source</div><div class="v" id="mSource"></div>
            <div class="k">Link</div><div class="v"><a id="mLink" href="#" target="_blank" rel="noopener noreferrer">Open source</a></div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn" id="mBookmarkBtn" type="button">★ Bookmark</button>
            <button class="btn" id="mCopyBtn" type="button">Copy citation</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Connections Viewer Panel -->
  <div class="connOverlayPanel" id="connPanel" aria-label="Connections panel">
    <div class="connCard">
      <div class="connCardHeader">
        <div class="t">Your connections</div>
        <button class="btn" id="closeConnPanel" type="button">Close</button>
      </div>
      <div class="connCardBody" id="connList"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /***********************
     * DATA
     ***********************/
    const RAW_ITEMS = [
      { date:"August 27, 2025", topic:"Preserving and Transferring Tacit Knowledge", subtopic:"Socially Interactive Agents (SIAs)",
        shortSummary:"AI-driven agents use empathic dialogue to elicit and retain employees’ tacit knowledge, facilitating onboarding and knowledge transfer.",
        fullDetails:"Socially Interactive Agents (SIAs) autonomously engage users via multimodal communication—verbal, nonverbal, and paraverbal—backed by LLMs, Retrieval-Augmented Generation, and Chain-of-Thought prompting. These agents help capture deeply held, implicit organizational knowledge (e.g., retiring experts’ heuristics), supporting onboarding and retention. Trust, transparency, privacy, and validation are critical for successful deployment.",
        link:"SIAs for tacit knowledge in organizations — arXiv, August 27 2025", newness:"Very new (late-2025 research)" },
      { date:"November 10, 2025", topic:"Decision Making in DAOs", subtopic:"QOC DAO model",
        shortSummary:"An AI-enabled Question-Option-Criteria framework enhances transparency and fairness in DAO decision-making.",
        fullDetails:"The QOC DAO model structures decision-making by breaking choices into questions, options, and criteria. AI agents guide weighted, criterion-based evaluations; statistical safeguards detect manipulation. The framework evolves from human-led to autonomous evaluations, enhancing scalability, accountability, and explainability in DAO governance.",
        link:"QOC DAO – arXiv, November 10 2025", newness:"Very new (late-2025 paper)" },
      { date:"November 26, 2025", topic:"AI’s Impact on Enterprise Decision-Making", subtopic:"Human-AI hybrid systems",
        shortSummary:"AI speeds analysis and improves decision clarity, but human adaptability and change management remain key barriers.",
        fullDetails:"Surveying 92 firms, the study finds 93% use AI in areas like customer service, forecasting, and decision support. AI improves decision speed and clarity, but challenges include employee resistance, high costs, regulatory ambiguity, and lack of change management. Successful adoption depends more on leadership adaptability and transparent processes than technical skills alone.",
        link:"Impact of AI on enterprise decision-making — arXiv, November 26 2025", newness:"Very new (late-2025 empirical study)" },
      { date:"October 24, 2025", topic:"Data Strategy for Agentic AI", subtopic:"Dynamic, Orchestrated, Proactive Data",
        shortSummary:"To support agentic AI, companies must shift to real-time, unified, and proactive data management.",
        fullDetails:"As agentic AI becomes capable of autonomous decision-making, organizations must transform data infrastructure: move from static to real-time streaming, break silos to orchestrate data across systems, and adopt proactive governance to manage quality, security, and anomaly detection. These shifts are essential to enable accurate, autonomous AI-driven decisions.",
        link:"Business Insider, October 24 2025 (agentic AI data shifts)", newness:"Very new (late-2025 trends)" },
      { date:"May 22, 2024", topic:"Bias Detection in Risky Decisions", subtopic:"Automatic Bias Identification (ABI)",
        shortSummary:"System detects and explains risk-seeking biases in decisions by applying behavioral economic theory.",
        fullDetails:"The ABI approach automatically identifies risk-seeking preferences (e.g., loss aversion) using an ontology grounded in Cumulative Prospect Theory. It provides real-time, actionable guidance in business language, making behavioral insights accessible without specialized personnel. It also collects historical decision data to inform long-term strategic management.",
        link:"ABI approach—arXiv, May 22 2024", newness:"Recent (2024), emerging practical tool" },
      { date:"February 12, 2025", topic:"Participatory Multi-Stakeholder Framework", subtopic:"Multi-actor decision optimization",
        shortSummary:"Optimizes decisions by balancing diverse stakeholder preferences via context-dependent reward functions.",
        fullDetails:"Defines decision-making as multi-stakeholder optimization. Models stakeholders via reward functions, uses cross-validation and compromise functions to rank strategies. Empirically validated, delivering recommendations that balance quality metrics across actors.",
        link:"https://arxiv.org/abs/2502.08542?utm_source=openai", newness:"Contemporary, multi-actor complexity focus" },
      { date:"2026-01-26", topic:"Virtual Top Manager Personas with LLMs", subtopic:"Simulating executive decision-making using LLM-based personas",
        shortSummary:"Framework that creates virtual CEOs using LLMs to model moral decision-making",
        fullDetails:"Researchers built LLM personas based on real CEOs using Moral Foundations Theory. Tested for validity, reliability, and realism, the personas effectively mirrored human moral judgments, providing a new tool for organizational research where direct access to executives is limited.",
        link:"https://arxiv.org/abs/2601.18512?utm_source=openai", newness:"Very new – published Jan 26, 2026; a novel methodological advance" },
      { date:"2025-09-23", topic:"Professional Decision-Making Gaps", subtopic:"Confidence vs actual structured decision habits in professionals",
        shortSummary:"Nearly half of professionals lack structured decision-making despite high confidence",
        fullDetails:"Survey by GAABS shows 91% of professionals rate themselves decision-skilled, yet 45% lack structured decision-making habits. Most lack formal training, rely on experience or personal networks, and organizational support is weak—recording, training, and process are often absent.",
        link:"https://sciencesources.eurekalert.org/news-releases/1099156?utm_source=openai", newness:"Published September 23, 2025; newly surfaced evidence on a persistent issue" },
      { date:"2026-02-03", topic:"AI-Driven Shifts in Consumer Decision-Making", subtopic:"AI complicating traditional consumer journey models",
        shortSummary:"AI is reshaping consumer decision paths, making them less linear and more complex",
        fullDetails:"A recent industry report indicates traditional consumer intelligence models can’t keep pace with AI-influenced consumer behavior. Journeys are nonlinear, opaque, and influenced by unseen factors, weakening existing marketing and research models.",
        link:"https://timesofindia.indiatimes.com/business/india-business/consumer-decision-making-shifting-with-ai-challenging-old-research-models/articleshow/127885239.cms?utm_source=openai",
        newness:"Very recent – published Feb 3, 2026" },
      { date:"2026-01-31", topic:"Business Decision Trends in 2026", subtopic:"Operationalizing data into consistent, actionable decisions",
        shortSummary:"Shift from data collection to disciplined, scalable decision execution using simulation and preventive analytics",
        fullDetails:"Organizations now focus on using data to drive consistent decisions—not just collect data. Key trends: embed quality in strategy, simulation over trial-and-error, digital transformation for actionable insight, preventive predictive analytics, and democratizing statistical thinking across teams.",
        link:"https://blog.minitab.com/en/blog/6-trends-shaping-business-decisions-in-2026?utm_source=openai",
        newness:"Current trends emerging in 2026 – industry-based evidence" },
      { date:"2026-02-05", topic:"Leadership Challenges Amid AI", subtopic:"AI stressing leadership capabilities and roles of HR",
        shortSummary:"AI accelerates demands on leaders; HR must bridge humans and AI through trust, judgment, and transparency",
        fullDetails:"AI adoption isn’t just technological—it reveals leadership weaknesses. Leaders must decide what to automate vs. human-retain, pace change, and manage stress. HR needs to foster trust, clarify decision-making, and develop leaders’ judgment, empathy, and ethical reasoning to combine AI with human capability. Transparency, candor, and visible reasoning build credibility when certainty is low.",
        link:"https://www.ddi.com/blog/hot-leadership-topics-2026?utm_source=openai",
        newness:"Very timely – published a couple days ago" },
      { date:"2026-02-06", topic:"AI Workforce Blueprint", subtopic:"Designing AI-integrated workforce strategy",
        shortSummary:"WEF outlines reshaping workforce through skills taxonomy, talent mobility, and governance",
        fullDetails:"The World Economic Forum emphasizes redesigning workforce models to prioritize skills over roles, implement internal talent marketplaces, and anchor AI use in transparent governance and inclusive design. This reframes AI from a technical tool to an organizational capability.",
        link:"https://www.linkedin.com/pulse/week-ending-february-6th-2026-trent-cotton-szlie?utm_source=openai",
        newness:"Published Feb 6, 2026; current guidance on AI-HR alignment" },
      { date:"2026-02-08", topic:"AI Agents as Core Digital Workers", subtopic:"Enterprises treating AI agents as essential workforce components",
        shortSummary:"74% of enterprises now consider AI agents core digital workers",
        fullDetails:"According to a LinkedIn AI Daily Digest published today, 74% of enterprises now treat AI agents as core digital workers rather than mere productivity tools. Also noted: AI-driven demand forecasting cuts retail stockouts by 31%, and enterprise spending on agent monitoring and reliability tools has grown 2.7× year-over-year—indicating a shift toward operational reliance on AI agents.",
        link:"https://www.linkedin.com/pulse/ai-daily-digest-february-8-2026-safwan-alsebaei-aufwf?utm_source=openai",
        newness:"Published February 8, 2026; reflects evolving organizational reliance on AI for core operations" },
      { date:"2026-02-13", topic:"Enterprise AI as Core Strategy", subtopic:"AI embedded in business strategy and operations, not just experimentation",
        shortSummary:"AI transitions from experiment to operational and strategic imperative in enterprises",
        fullDetails:"Organizations are now embedding AI in long-term strategy, allocating budgets, training teams, and developing risk frameworks; moving AI from a side capability to a core ingredient of business success.",
        link:"https://m.economictimes.com/ai/ai-insights/et-genai-hackathon-why-enterprise-ai-success-depends-on-collaboration/articleshow/128305793.cms?utm_source=openai",
        newness:"Very recent – published Feb 13, 2026; shows AI’s central business role" },
      { date:"2026-02-13", topic:"Global AI Safety Governance Advances", subtopic:"UN creates independent 40-member scientific panel to assess global AI impacts",
        shortSummary:"UN General Assembly forms a 40-member scientific panel for global AI impact assessment",
        fullDetails:"The UN General Assembly approved the formation of a 40-member global scientific panel led by Secretary-General António Guterres, with a vote of 117–2, aiming to deliver independent scientific insights on AI’s societal and economic impacts and bridge knowledge gaps among member states.",
        link:"https://apnews.com/article/8936f242689792be7a7ab97e841cade8?utm_source=openai",
        newness:"Published Feb 13, 2026; represents real-time progress in international AI governance" }
    ];

    /***********************
     * HELPERS
     ***********************/
    const $ = (s, el=document)=> el.querySelector(s);
    const $$ = (s, el=document)=> [...el.querySelectorAll(s)];

    function parseDateToISO(dateStr){
      if(!dateStr) return null;
      const t = String(dateStr).trim();
      if(/^\d{4}-\d{2}-\d{2}$/.test(t)) return t;
      const d = new Date(t);
      if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
      return null;
    }
    function formatPrettyDate(iso){
      if(!iso) return "Unknown";
      const [y,m,d] = iso.split("-").map(Number);
      const dt = new Date(Date.UTC(y, m-1, d));
      return dt.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
    }
    function safeURLFromLinkField(linkField){
      const s = (linkField || "").trim();
      return /^https?:\/\//i.test(s) ? s : null;
    }
    function sourceLabel(item){
      const url = safeURLFromLinkField(item.link);
      if(url){
        try{ return new URL(url).hostname.replace(/^www\./,""); } catch(e){ return "source"; }
      }
      const t = (item.link || "").trim();
      const cut = t.split(",")[0].trim();
      return (cut.length > 40) ? cut.slice(0,40) + "…" : (cut || "source");
    }
    function sourceHost(item){
      const url = safeURLFromLinkField(item.link);
      if(url){
        try{ return new URL(url).hostname.replace(/^www\./,""); } catch(e){ return "source"; }
      }
      return sourceLabel(item);
    }
    function makeId(item){
      const base = `${item.date}|${item.topic}|${item.subtopic}`.toLowerCase();
      let h = 0;
      for(let i=0;i<base.length;i++){ h = ((h<<5)-h) + base.charCodeAt(i); h |= 0; }
      return "n" + Math.abs(h);
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function shorten(s,n){
      s = (s || "").trim();
      if(s.length <= n) return s;
      return s.slice(0, n-1) + "…";
    }
    function daysBetween(isoA, isoB){
      const a = new Date(isoA + "T00:00:00Z").getTime();
      const b = new Date(isoB + "T00:00:00Z").getTime();
      return Math.floor((a - b) / 86400000);
    }
    function isRecentByWindow(item, windowDays, nowISO){
      if(windowDays === 0) return true;
      return daysBetween(nowISO, item.iso) <= windowDays;
    }
    function freshnessClass(item, nowISO){
      const d = daysBetween(nowISO, item.iso);
      if(d <= 7) return "fresh-7";
      if(d <= 30) return "fresh-30";
      if(d <= 365) return "fresh-365";
      return "";
    }
    function freshnessTag(item, nowISO){
      const d = daysBetween(nowISO, item.iso);
      if(d <= 7) return { cls:"hot", label:"New (≤ 7d)" };
      if(d <= 30) return { cls:"green", label:"Fresh (≤ 30d)" };
      if(d <= 365) return { cls:"amber", label:"In-year (≤ 1y)" };
      return { cls:"", label:"Archive" };
    }

    /***********************
     * STATE
     ***********************/
    const NOW_ISO = new Date().toISOString().slice(0,10);
    const ITEMS = RAW_ITEMS.map(it => ({
      ...it,
      id: makeId(it),
      iso: parseDateToISO(it.date) || "1900-01-01",
      url: safeURLFromLinkField(it.link),
      source: sourceLabel(it),
      host: sourceHost(it),
    }));

    const BOOKMARKS_KEY = "dib_bookmarks_conn_v1";
    const THEME_KEY = "dib_theme_conn_v1";
    const EDGES_KEY = "dib_connections_v1"; // renamed to "connections"
    let bookmarks = new Set(JSON.parse(localStorage.getItem(BOOKMARKS_KEY) || "[]"));
    let edges = JSON.parse(localStorage.getItem(EDGES_KEY) || "[]"); // {from,to,createdAt}

    const state = { q:"", interest:"all", sort:"cluster_then_date_desc", timeWindow:0 };
    const connect = { on:false, fromId:null }; // super simple: pick from → pick to

    /***********************
     * THEME
     ***********************/
    function setTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      toast(theme === "dark" ? "Dark theme." : "Light theme.");
    }
    function getTheme(){ return localStorage.getItem(THEME_KEY) || "light"; }

    /***********************
     * CONTROLS
     ***********************/
    function initControls(){
      const topics = ["all", ...Array.from(new Set(ITEMS.map(x=>x.topic))).sort((a,b)=>a.localeCompare(b))];
      $("#interestSelect").innerHTML = topics.map(t => `<option value="${escapeHtml(t)}">${t==="all" ? "All areas of interest" : t}</option>`).join("");
      $("#interestSelect").addEventListener("change", (e)=>{ state.interest = e.target.value; render(); });

      const chips = [
        { days:0, label:"All time" },
        { days:7, label:"Newest (7d)" },
        { days:30, label:"Last 30d" },
        { days:365, label:"Last 1y" },
        { days:-1, label:"Bookmarks" },
      ];
      $("#timeChips").innerHTML = chips.map(c => `<div class="chip ${c.days===state.timeWindow?"active":""}" data-days="${c.days}" role="button" tabindex="0">${escapeHtml(c.label)}</div>`).join("");
      $("#timeChips").addEventListener("click",(e)=>{
        const el = e.target.closest(".chip"); if(!el) return;
        state.timeWindow = Number(el.dataset.days);
        $$("#timeChips .chip").forEach(x=>x.classList.toggle("active", Number(x.dataset.days)===state.timeWindow));
        render();
      });

      $("#q").addEventListener("input",(e)=>{ state.q = e.target.value.trim(); render(); });
      $("#sortSelect").addEventListener("change",(e)=>{ state.sort = e.target.value; render(); });

      $("#resetBtn").addEventListener("click", ()=>{
        state.q=""; state.interest="all"; state.sort="cluster_then_date_desc"; state.timeWindow=0;
        $("#q").value=""; $("#interestSelect").value="all"; $("#sortSelect").value="cluster_then_date_desc";
        $$("#timeChips .chip").forEach(x=>x.classList.toggle("active", Number(x.dataset.days)===0));
        setConnect(false);
        render();
        toast("Reset done.");
      });

      $("#copyBtn").addEventListener("click", async ()=>{
        const list = flattenFiltered().map((x,i)=>{
          const linkPart = x.url ? x.url : x.link;
          return `${i+1}. ${x.topic} — ${x.subtopic} (${formatPrettyDate(x.iso)}) · ${x.source} · ${linkPart}`;
        }).join("\n");
        await copyToClipboard(list || "No items to copy.");
        toast("Copied sources.");
      });

      $("#themeBtn").addEventListener("click", ()=>{
        const cur = document.documentElement.getAttribute("data-theme") || "light";
        setTheme(cur==="light" ? "dark" : "light");
      });

      // Connections controls
      $("#connectToggle").addEventListener("click", ()=> setConnect(!connect.on));
      $("#connectToggle").addEventListener("keydown",(e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); setConnect(!connect.on);} });

      $("#viewConnectionsBtn").addEventListener("click", ()=> openConnectionsPanel());
      $("#closeConnPanel").addEventListener("click", ()=> closeConnectionsPanel());

      $("#clearConnectionsBtn").addEventListener("click", ()=>{
        edges = [];
        persistEdges();
        toast("Connections cleared.");
        updateEdgeCount();
        renderConnectionsPanel();
      });

      $("#closeModal").addEventListener("click", closeModal);
      $("#modalOverlay").addEventListener("click", (e)=>{ if(e.target.id==="modalOverlay") closeModal(); });

      $("#mBookmarkBtn").addEventListener("click", ()=>{
        if(!window.__modalItem) return;
        toggleBookmark(window.__modalItem.id);
        openModal(window.__modalItem);
      });

      $("#mCopyBtn").addEventListener("click", async ()=>{
        const x = window.__modalItem; if(!x) return;
        const citation = `${x.topic} — ${x.subtopic} (${formatPrettyDate(x.iso)}). Source: ${x.source}. ${x.url ? x.url : x.link}`;
        await copyToClipboard(citation);
        toast("Copied citation.");
      });

      document.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ closeModal(); closeConnectionsPanel(); if(connect.on) setConnect(false); } });

      updateEdgeCount();
    }

    function setConnect(on){
      connect.on = on;
      connect.fromId = null;

      $("#connectToggle").classList.toggle("active", on);
      $("#connectToggle").setAttribute("aria-pressed", on ? "true" : "false");
      $("#toggleText").textContent = on ? "On" : "Off";

      $("#helpText").innerHTML = on
        ? `Step 1: click a <b>From</b> article. Step 2: click a <b>To</b> article.`
        : `Turn on → click <b>From</b> article → click <b>To</b> article.`;

      toast(on ? "Connections ON. Pick FROM then TO." : "Connections OFF.");
      render();
    }

    /***********************
     * FILTERING + ORDER
     ***********************/
    function baseFiltered(){
      let list = [...ITEMS];
      if(state.timeWindow === -1) list = list.filter(x=>bookmarks.has(x.id));
      else list = list.filter(x=>isRecentByWindow(x, state.timeWindow, NOW_ISO));
      if(state.interest !== "all") list = list.filter(x=>x.topic===state.interest);
      if(state.q){
        const needle = state.q.toLowerCase();
        list = list.filter(x => (`${x.topic} ${x.subtopic} ${x.shortSummary} ${x.fullDetails} ${x.source} ${x.link}`).toLowerCase().includes(needle));
      }
      return list;
    }
    function groupByTopic(list){
      const map = new Map();
      for(const item of list){
        if(!map.has(item.topic)) map.set(item.topic, []);
        map.get(item.topic).push(item);
      }
      return map;
    }
    function sortWithin(arr){
      if(state.sort.includes("date_desc")) arr.sort((a,b)=> b.iso.localeCompare(a.iso));
      else arr.sort((a,b)=> a.iso.localeCompare(b.iso));
      return arr;
    }
    function flattenFiltered(){
      const list = baseFiltered();
      if(state.sort === "date_desc") return list.sort((a,b)=> b.iso.localeCompare(a.iso));
      if(state.sort === "date_asc") return list.sort((a,b)=> a.iso.localeCompare(b.iso));
      const g = groupByTopic(list);
      const topics = [...g.keys()].sort((a,b)=>a.localeCompare(b));
      return topics.flatMap(t => sortWithin(g.get(t)));
    }

    /***********************
     * RENDER
     ***********************/
    function render(){
      const filtered = baseFiltered();
      $("#statTotal").textContent = String(ITEMS.length);
      $("#statVisible").textContent = String(filtered.length);

      const clustersEl = $("#clusters");
      const emptyEl = $("#empty");

      if(filtered.length === 0){
        clustersEl.innerHTML = "";
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      if(state.sort === "date_desc" || state.sort === "date_asc"){
        const all = [...filtered].sort((a,b)=> state.sort==="date_desc" ? b.iso.localeCompare(a.iso) : a.iso.localeCompare(b.iso));
        clustersEl.innerHTML = clusterHTML("All topics", all);
      } else {
        const grouped = groupByTopic(filtered);
        const keys = [...grouped.keys()].sort((a,b)=>a.localeCompare(b));
        clustersEl.innerHTML = keys.map(k => clusterHTML(k, sortWithin(grouped.get(k)))).join("");
      }

      // Bind row events + per-row actions
      $$(".row", clustersEl).forEach(r=>{
        const id = r.dataset.id;
        const item = ITEMS.find(x=>x.id===id);

        // Connection mode visuals
        r.classList.toggle("connectMode", connect.on);
        r.classList.toggle("selectedFrom", connect.on && connect.fromId === id);

        r.addEventListener("click", (e)=>{
          if(e.target.closest("button") || e.target.closest("a")) return;

          if(connect.on){
            handleConnectClick(id);
            return;
          }
          openModal(item);
        });

        r.querySelector(".iconBtn.star").addEventListener("click",(e)=>{
          e.stopPropagation();
          toggleBookmark(id);
          e.currentTarget.classList.toggle("active", bookmarks.has(id));
          toast(bookmarks.has(id) ? "Bookmarked." : "Removed bookmark.");
          if(state.timeWindow === -1) render();
        });

        r.querySelector(".iconBtn.open").addEventListener("click",(e)=>{
          e.stopPropagation();
          if(item.url) window.open(item.url, "_blank", "noopener,noreferrer");
          else { openModal(item); toast("No direct URL in this row — showing details."); }
        });

        // NEW: Connect button just toggles Connections mode ON (if off) and selects FROM if on.
        r.querySelector(".iconBtn.connect").addEventListener("click",(e)=>{
          e.stopPropagation();
          if(!connect.on) setConnect(true);
          handleConnectClick(id);
        });
      });

      updateEdgeCount();
    }

    function clusterHTML(topic, items){
      const newest = items.reduce((acc,x)=> acc > x.iso ? acc : x.iso, "1900-01-01");
      const newestAge = daysBetween(NOW_ISO, newest);
      const freshnessPill =
        newestAge <= 7 ? `<span class="pill hot"><span class="b"></span>Newest ≤ 7d</span>` :
        newestAge <= 30 ? `<span class="pill"><span class="b"></span>Newest ≤ 30d</span>` :
        newestAge <= 365 ? `<span class="pill warn"><span class="b"></span>Newest ≤ 1y</span>` :
        `<span class="pill warn"><span class="b"></span>Archive</span>`;

      const countPill = `<span class="pill"><span class="b"></span>${items.length} item${items.length===1?"":"s"}</span>`;
      const rows = items.map(x => rowHTML(x)).join("");

      return `
        <section class="cluster">
          <div class="clusterHeader">
            <h2>${escapeHtml(topic)}</h2>
            <div class="clusterMeta">${countPill}${freshnessPill}</div>
          </div>
          <div class="rows">${rows}</div>
        </section>
      `;
    }

    function rowHTML(x){
      const starActive = bookmarks.has(x.id);
      const tag = freshnessTag(x, NOW_ISO);
      const fcls = freshnessClass(x, NOW_ISO);
      const dotCls = (daysBetween(NOW_ISO, x.iso) <= 7) ? "d hot" : "d";

      return `
        <div class="row ${fcls}" data-id="${escapeHtml(x.id)}" role="button" tabindex="0">
          <span class="badge">${escapeHtml(shorten(x.topic, 22))}</span>

          <div class="cell date">
            <span class="${dotCls}"></span>
            ${escapeHtml(formatPrettyDate(x.iso))}
          </div>

          <div class="cell">
            <div class="topic" title="${escapeHtml(x.topic)}">${escapeHtml(x.topic)}</div>
          </div>

          <div class="cell">
            <div class="subtopic" title="${escapeHtml(x.subtopic)}">${escapeHtml(x.subtopic)}</div>
          </div>

          <div class="cell">
            <div class="summary">${escapeHtml(shorten(x.shortSummary, 220))}</div>
          </div>

          <div class="cell">
            <div class="src">
              <div class="lbl">from</div>
              <div class="srcHost" title="${escapeHtml(x.host)}">${escapeHtml(x.host)}</div>
              <span class="tag ${tag.cls}"><span class="b"></span>${escapeHtml(tag.label)}</span>
            </div>
          </div>

          <div class="cell actions">
            <button class="iconBtn star ${starActive ? "active":""}" type="button" title="Bookmark">★</button>
            <button class="iconBtn connect" type="button" title="Create a connection">Connect</button>
            <button class="iconBtn open" type="button" title="Open source">${x.url ? "Open" : "…"}</button>
          </div>
        </div>
      `;
    }

    /***********************
     * CONNECTIONS UX (SIMPLE)
     ***********************/
    function handleConnectClick(id){
      // Step 1: pick FROM
      if(!connect.fromId){
        connect.fromId = id;
        toast("Now pick the TO article.");
        // highlight
        render();
        return;
      }

      // Step 2: pick TO
      if(connect.fromId === id){
        connect.fromId = null;
        toast("From selection cleared. Pick FROM again.");
        render();
        return;
      }

      addConnection(connect.fromId, id);
      connect.fromId = null;
      render();
      renderConnectionsPanel();
    }

    function addConnection(fromId, toId){
      if(edges.some(e=>e.from===fromId && e.to===toId)){
        toast("That connection already exists.");
        return;
      }
      edges.push({ from: fromId, to: toId, createdAt: new Date().toISOString() });
      persistEdges();
      updateEdgeCount();
      toast("Connected ✔");
      // auto-open viewer panel so user sees result (much clearer)
      openConnectionsPanel(true);
    }

    function persistEdges(){ localStorage.setItem(EDGES_KEY, JSON.stringify(edges)); }

    function updateEdgeCount(){
      $("#edgeCount").textContent = `${edges.length} connection${edges.length===1?"":"s"}`;
    }

    function openConnectionsPanel(noToast=false){
      $("#connPanel").classList.add("show");
      renderConnectionsPanel();
      if(!noToast) toast("Connections opened.");
    }
    function closeConnectionsPanel(){
      $("#connPanel").classList.remove("show");
    }

    function renderConnectionsPanel(){
      const listEl = $("#connList");
      if(!listEl) return;

      if(edges.length === 0){
        listEl.innerHTML = `
          <div class="edgeItem">
            <div class="edgeTop">
              <div class="label">No connections yet</div>
              <div class="mini">Tip</div>
            </div>
            <div style="margin-top:8px; font-size:12px; color: var(--muted); line-height:1.4;">
              Turn <b>Connections</b> on, click one article (From), then click another (To).
            </div>
          </div>
        `;
        return;
      }

      // newest connections first
      const sorted = [...edges].sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));

      listEl.innerHTML = sorted.map((e, idx)=>{
        const from = ITEMS.find(x=>x.id===e.from);
        const to = ITEMS.find(x=>x.id===e.to);
        const fromLabel = from ? shorten(from.topic, 48) : e.from;
        const toLabel = to ? shorten(to.topic, 48) : e.to;
        const when = e.createdAt ? new Date(e.createdAt).toLocaleString() : "";

        return `
          <div class="edgeItem" data-edge="${idx}">
            <div class="edgeTop">
              <div class="label">“${escapeHtml(fromLabel)}” → “${escapeHtml(toLabel)}”</div>
              <div class="mini">${escapeHtml(when)}</div>
            </div>
            <div class="edgeBtns">
              <button class="tinyBtn" data-open="${escapeHtml(e.from)}">Open FROM</button>
              <button class="tinyBtn" data-open="${escapeHtml(e.to)}">Open TO</button>
              <button class="tinyBtn danger" data-del="${escapeHtml(e.from)}|${escapeHtml(e.to)}">Delete</button>
            </div>
          </div>
        `;
      }).join("");

      // bind buttons
      $$("[data-open]", listEl).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.open;
          const item = ITEMS.find(x=>x.id===id);
          if(item) openModal(item);
        });
      });
      $$("[data-del]", listEl).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const [from,to] = btn.dataset.del.split("|");
          edges = edges.filter(e=>!(e.from===from && e.to===to));
          persistEdges();
          updateEdgeCount();
          renderConnectionsPanel();
          toast("Connection deleted.");
        });
      });
    }

    /***********************
     * BOOKMARKS + DETAILS
     ***********************/
    function toggleBookmark(id){
      if(bookmarks.has(id)) bookmarks.delete(id);
      else bookmarks.add(id);
      localStorage.setItem(BOOKMARKS_KEY, JSON.stringify([...bookmarks]));
    }

    function openModal(item){
      if(!item) return;
      window.__modalItem = item;
      $("#mTitle").textContent = item.topic;
      $("#mSub").textContent = item.subtopic;
      $("#mDetails").textContent = item.fullDetails;

      $("#mDate").textContent = formatPrettyDate(item.iso);
      $("#mTopic").textContent = item.topic;
      $("#mSubtopic").textContent = item.subtopic;
      $("#mNewness").textContent = item.newness;
      $("#mSource").textContent = item.source;

      const a = $("#mLink");
      if(item.url){
        a.href=item.url; a.textContent="Open source"; a.style.opacity="1"; a.style.pointerEvents="auto";
      } else {
        a.href="#"; a.textContent="No direct URL in table row"; a.style.opacity=".7"; a.style.pointerEvents="none";
      }
      $("#mBookmarkBtn").textContent = bookmarks.has(item.id) ? "★ Bookmarked" : "★ Bookmark";
      $("#modalOverlay").classList.add("show");
    }
    function closeModal(){ $("#modalOverlay").classList.remove("show"); window.__modalItem=null; }

    /***********************
     * LIST RENDER
     ***********************/
    function renderList(){
      const filtered = baseFiltered();
      $("#statTotal").textContent = String(ITEMS.length);
      $("#statVisible").textContent = String(filtered.length);

      const clustersEl = $("#clusters");
      const emptyEl = $("#empty");

      if(filtered.length === 0){
        clustersEl.innerHTML = "";
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";

      if(state.sort === "date_desc" || state.sort === "date_asc"){
        const all = [...filtered].sort((a,b)=> state.sort==="date_desc" ? b.iso.localeCompare(a.iso) : a.iso.localeCompare(b.iso));
        clustersEl.innerHTML = clusterHTML("All topics", all);
      } else {
        const grouped = groupByTopic(filtered);
        const keys = [...grouped.keys()].sort((a,b)=>a.localeCompare(b));
        clustersEl.innerHTML = keys.map(k => clusterHTML(k, sortWithin(grouped.get(k)))).join("");
      }

      $$(".row", clustersEl).forEach(r=>{
        const id = r.dataset.id;
        const item = ITEMS.find(x=>x.id===id);

        r.classList.toggle("connectMode", connect.on);
        r.classList.toggle("selectedFrom", connect.on && connect.fromId === id);

        r.addEventListener("click", (e)=>{
          if(e.target.closest("button") || e.target.closest("a")) return;
          if(connect.on){ handleConnectClick(id); return; }
          openModal(item);
        });

        r.querySelector(".iconBtn.star").addEventListener("click",(e)=>{
          e.stopPropagation();
          toggleBookmark(id);
          e.currentTarget.classList.toggle("active", bookmarks.has(id));
          toast(bookmarks.has(id) ? "Bookmarked." : "Removed bookmark.");
          if(state.timeWindow === -1) renderList();
        });

        r.querySelector(".iconBtn.open").addEventListener("click",(e)=>{
          e.stopPropagation();
          if(item.url) window.open(item.url, "_blank", "noopener,noreferrer");
          else { openModal(item); toast("No direct URL in this row — showing details."); }
        });

        r.querySelector(".iconBtn.connect").addEventListener("click",(e)=>{
          e.stopPropagation();
          if(!connect.on) setConnect(true);
          handleConnectClick(id);
        });
      });

      updateEdgeCount();
    }

    function render(){
      renderList();
      // Keep connections panel content current if open
      if($("#connPanel").classList.contains("show")) renderConnectionsPanel();
    }

    /***********************
     * TOAST + CLIPBOARD
     ***********************/
    async function copyToClipboard(text){
      try{ await navigator.clipboard.writeText(text); }
      catch(e){
        const ta=document.createElement("textarea");
        ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px";
        document.body.appendChild(ta); ta.focus(); ta.select();
        document.execCommand("copy"); ta.remove();
      }
    }
    let toastTimer=null;
    function toast(msg){
      const el=$("#toast");
      el.textContent=msg;
      el.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>el.classList.remove("show"),2200);
    }

    /***********************
     * BOOT
     ***********************/
    setTheme(getTheme());
    initControls();
    render();
  </script>
</body>
</html>
